
          <section id="arc-28-structured-event-logging">
<h1>ARC-28: Structured event logging<a class="headerlink" href="#arc-28-structured-event-logging" title="Link to this heading">¶</a></h1>
<p><a class="reference external" href="https://github.com/algorandfoundation/ARCs/blob/main/ARCs/arc-0028.md">ARC-28</a> provides a methodology for structured logging by Algorand smart contracts. It introduces the concept of Events, where data contained in logs may be categorized and structured.</p>
<p>Each Event is identified by a unique 4-byte identifier derived from its <code class="docutils literal notranslate"><span class="pre">Event</span> <span class="pre">Signature</span></code>. The Event Signature is a UTF-8 string comprised of the event’s name, followed by the names of the <a class="reference internal" href="lg-arc4.html"><span class="std std-doc">ARC-4</span></a> data types contained in the event, all enclosed in parentheses (<code class="docutils literal notranslate"><span class="pre">EventName(type1,type2,...)</span></code>) e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Swapped</span><span class="p">(</span><span class="n">uint64</span><span class="p">,</span><span class="n">uint64</span><span class="p">)</span>
</pre></div>
</div>
<p>Events are emitting by including them in the <a class="reference internal" href="lg-logs.html"><span class="std std-doc">log output</span></a>. The metadata that identifies the event should then be included in the ARC-4 contract output so that a calling client can parse the logs to parse the structured data out. This part of the ARC-28 spec isn’t yet implemented in Algorand Python, but it’s on the roadmap.</p>
<section id="emitting-events">
<h2>Emitting Events<a class="headerlink" href="#emitting-events" title="Link to this heading">¶</a></h2>
<p>To emit an ARC-28 event in Algorand Python you can use the <code class="docutils literal notranslate"><span class="pre">emit</span></code> function, which appears in the <code class="docutils literal notranslate"><span class="pre">algopy.arc4</span></code> namespace for convenience since it heavily uses ARC-4 types and is essentially an extension of the ARC-4 specification. This function takes care of encoding the event payload to conform to the ARC-28 specification and there are 3 overloads:</p>
<ul class="simple">
<li><p>An <a class="reference internal" href="lg-arc4.html"><span class="std std-doc">ARC-4 struct</span></a>, from what the name of the struct will be used as a the event name and the struct parameters will be used as the event fields - <code class="docutils literal notranslate"><span class="pre">arc4.emit(Swapped(a,</span> <span class="pre">b))</span></code></p></li>
<li><p>An event signature as a <a class="reference internal" href="lg-types.html"><span class="std std-doc">string literal (or module variable)</span></a>, followed by the values - <code class="docutils literal notranslate"><span class="pre">arc4.emit("Swapped(uint64,uint64)",</span> <span class="pre">a,</span> <span class="pre">b)</span></code></p></li>
<li><p>An event name as a <a class="reference internal" href="lg-types.html"><span class="std std-doc">string literal (or module variable)</span></a>, followed by the values - <code class="docutils literal notranslate"><span class="pre">arc4.emit("Swapped",</span> <span class="pre">a,</span> <span class="pre">b)</span></code></p></li>
</ul>
<p>Here’s an example contract that emits events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">algopy</span> <span class="kn">import</span> <span class="n">ARC4Contract</span><span class="p">,</span> <span class="n">arc4</span>

<span class="k">class</span> <span class="nc">Swapped</span><span class="p">(</span><span class="n">arc4</span><span class="o">.</span><span class="n">Struct</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">arc4</span><span class="o">.</span><span class="n">UInt64</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">arc4</span><span class="o">.</span><span class="n">UInt64</span>

<span class="k">class</span> <span class="nc">EventEmitter</span><span class="p">(</span><span class="n">ARC4Contract</span><span class="p">):</span>
    <span class="nd">@arc4</span><span class="o">.</span><span class="n">abimethod</span>
    <span class="k">def</span> <span class="nf">emit_swapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">arc4</span><span class="o">.</span><span class="n">UInt64</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">arc4</span><span class="o">.</span><span class="n">UInt64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arc4</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Swapped</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="n">arc4</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">"Swapped(uint64,uint64)"</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">arc4</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">"Swapped"</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s worth noting that the ARC-28 event signature needs to be known at compile time so the event name can’t be a dynamic type and must be a static string literal or string module constant. If you want to emit dynamic events you can do so using the <a class="reference internal" href="lg-logs.html"><span class="std std-doc"><code class="docutils literal notranslate"><span class="pre">log</span></code> method</span></a>, but you’d need to manually construct the correct series of bytes and the compiler won’t be able to emit the ARC-28 metadata so you’ll need to also manually parse the logs in your client.</p>
<p>Examples of manually constructing an event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is essentially what the `emit` method is doing, noting that a,b need to be encoded</span>
<span class="c1">#   as a tuple so below (simple concat) only works for static ARC-4 types</span>
<span class="n">log</span><span class="p">(</span><span class="n">arc4</span><span class="o">.</span><span class="n">arc4_signature</span><span class="p">(</span><span class="s2">"Swapped(uint64,uint64)"</span><span class="p">),</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># or, if you wanted it to be truly dynamic for some reason,</span>
<span class="c1">#   (noting this has a non-trivial opcode cost) and assuming in this case</span>
<span class="c1">#   that `event_suffix` is already defined as a `String`:</span>
<span class="n">event_name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="s2">"Event"</span><span class="p">)</span> <span class="o">+</span> <span class="n">event_suffix</span>
<span class="n">event_selector</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">sha512_256</span><span class="p">((</span><span class="n">event_name</span> <span class="o">+</span> <span class="s2">"(uint64)"</span><span class="p">)</span><span class="o">.</span><span class="n">bytes</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">log</span><span class="p">(</span><span class="n">event_selector</span><span class="p">,</span> <span class="n">UInt64</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>

        